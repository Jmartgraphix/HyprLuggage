#!/bin/bash
#|---/ /+---------------------+---/ /|#
#|--/ /-| Hyprluggage         |--/ /-|#
#|-/ /--| Theme Manager TUI   |-/ /--|#
#|/ /---+---------------------+/ /---|#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES="$(dirname "$(dirname "$SCRIPT_DIR")")"
THEMES_DIR="$DOTFILES/themes"
BRANDING="$DOTFILES/branding"
API="https://omarchythemes.com/api/themes/all"

C_ACCENT="\033[38;5;218m"
C_DIM="\033[38;5;245m"
C_OK="\033[38;5;215m"
C_ERR="\033[38;5;203m"
C_RESET="\033[0m"

command -v gum &>/dev/null || { echo "need gum"; exit 1; }

# gum choose wrappers with consistent styling
choose() {
    gum choose --cursor="â€º " --show-help "$@"
}

choose_multi() {
    local header="${1:-Select items}"
    shift
    gum choose --no-limit \
        --cursor="â€º " \
        --cursor-prefix="â—‹ " \
        --selected-prefix="â— " \
        --unselected-prefix="â—‹ " \
        --header "$header (x toggle â€¢ â†â†“â†‘â†’ navigate â€¢ enter submit â€¢ ctrl+a select all)" \
        "$@"
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Browse Omarchy Themes                                                 â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

browse_inner() {
    local data
    data=$(curl -sL "$API") || { echo -e "${C_ERR}fetch failed${C_RESET}"; sleep 2; return 1; }
    
    local preview_script
    preview_script=$(mktemp)
    trap "rm -f '$preview_script'" RETURN
    
    cat > "$preview_script" <<'EOF'
#!/bin/bash
[[ -z "$1" || "$1" == "null" ]] && exit 0
command -v chafa &>/dev/null && curl -sL "$1" 2>/dev/null | chafa -s "${FZF_PREVIEW_COLUMNS:-60}x${FZF_PREVIEW_LINES:-30}" -
EOF
    chmod +x "$preview_script"
    
    local sel
    sel=$(echo "$data" | jq -r '.[] | select(.url | startswith("https://github.com")) | [.name, .url, .preview_img] | @tsv' | sort | \
        fzf --delimiter=$'\t' --with-nth=1 \
            --preview="$preview_script {3}" \
            --preview-window=right:50% \
            --prompt="â€º " --pointer="â€º" \
            --layout=reverse) || return 0
    
    [[ -z "$sel" ]] && return 0
    
    local url
    url=$(cut -f2 <<< "$sel")
    
    echo ""
    "$SCRIPT_DIR/hyprluggage-import/import.sh" "$url" && echo -e "${C_OK}done${C_RESET}" || echo -e "${C_ERR}failed${C_RESET}"
    sleep 2
}

browse() { kitty --title hyprluggage-browse -e "$0" --browse-inner 2>/dev/null; }

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Delete Themes                                                         â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

delete_themes() {
    local themes=()
    
    for d in "$THEMES_DIR"/*/; do
        local t=$(basename "$d")
        [[ "$t" != "Wallpapers" && "$t" != "dynamic" ]] && themes+=("$t")
    done
    
    [[ ${#themes[@]} -eq 0 ]] && { echo -e "${C_ERR}no themes to delete${C_RESET}"; sleep 1; return; }
    
    mapfile -t themes < <(printf '%s\n' "${themes[@]}" | sort)
    
    local result
    result=$(printf '%s\n' "${themes[@]}" | choose_multi "Select themes to delete" --height=15) || return
    [[ -z "$result" ]] && return
    
    echo -e "\n${C_DIM}deleting:${C_RESET}"
    while IFS= read -r theme; do
        echo -e "  ${C_ERR}$theme${C_RESET}"
    done <<< "$result"
    echo ""
    
    gum confirm "confirm?" || return
    
    while IFS= read -r theme; do
        "$SCRIPT_DIR/hyprluggage" remove "$theme" <<< "y" 2>/dev/null
    done <<< "$result"
    echo -e "${C_OK}done${C_RESET}"
    sleep 1
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Import Theme                                                          â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

import_url() {
    echo -e "${C_DIM}e.g. https://github.com/bjarneo/omarchy-sakura-theme${C_RESET}"
    echo ""
    
    local url
    url=$(gum input --placeholder "user/repo or github url" --width=50)
    [[ -z "$url" ]] && return
    echo ""
    
    "$SCRIPT_DIR/hyprluggage-import/import.sh" "$url" && echo -e "${C_OK}done${C_RESET}" || echo -e "${C_ERR}failed${C_RESET}"
    sleep 2
}

omarchy_menu() {
    clear
    gum style --bold --foreground 212 "ðŸ§³ omarchy themes"
    echo ""
    
    local choice
    choice=$(choose "Browse" "Import" "Back")
    
    case "$choice" in
        "Browse") browse ;;
        "Import") import_url ;;
        *)        return ;;
    esac
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Web Apps                                                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

WEBAPP_DIR="$DOTFILES/.config/hypr/scripts"

webapp_menu() {
    clear
    gum style --bold --foreground 212 "ðŸ§³ web apps"
    echo ""
    
    local choice
    choice=$(choose "Install" "Remove" "Back")
    
    case "$choice" in
        "Install") "$WEBAPP_DIR/webapp-install"; sleep 1; webapp_menu ;;
        "Remove")  "$WEBAPP_DIR/webapp-remove"; sleep 1; webapp_menu ;;
        *)         return ;;
    esac
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Main Menu                                                             â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

show_banner() {
    [[ ! -f "$BRANDING/hyprluggage.txt" ]] && return
    
    if command -v tte &>/dev/null; then
        tte \
            --frame-rate 120 expand \
            --movement-speed 0.5 \
            --expand-easing IN_OUT_QUART \
            --final-gradient-stops FFEB3B FFB74D FF8A80 F48FB1 EC407A \
            --final-gradient-steps 12 \
            --final-gradient-frames 3 \
            --final-gradient-direction vertical < "$BRANDING/hyprluggage.txt" 2>/dev/null && return
    fi
    
    echo -e "${C_ACCENT}"
    cat "$BRANDING/hyprluggage.txt"
    echo -e "${C_RESET}"
}

main() {
    clear
    echo ""
    show_banner
    echo ""
    
    local choice
    choice=$(choose "Web Apps" "Choose Shell" "Omarchy Themes" "Delete Themes" "Exit")
    
    case "$choice" in
        "Omarchy Themes") omarchy_menu; main ;;
        "Web Apps")       webapp_menu; main ;;
        "Choose Shell")   "$DOTFILES/scripts/choose-shell"; main ;;
        "Delete Themes")  delete_themes; main ;;
        *)                clear; exit 0 ;;
    esac
}

[[ "$1" == "--browse-inner" ]] && { browse_inner; exit 0; }
main
